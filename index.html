<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Playlist Insights & Mood Number Line</title>


    <!-- ======================== -->
    <!--       External Links     -->
    <!-- ======================== -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">


    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   
    <!-- html2canvas Library -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


    <!-- ======================== -->
    <!--         Styles           -->
    <!-- ======================== -->
    <style>
        /* ------------------------ */
        /*        General Styles    */
        /* ------------------------ */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #FFFFFF;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 50px;
            margin: 0;
            min-height: 100vh;
        }


        h1 {
            color: #1DB954;
            font-size: 2.5em;
            margin-bottom: 20px;
        }


        /* ------------------------ */
        /*        Input Styles      */
        /* ------------------------ */
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }


        input[type="text"] {
            width: 80%;
            max-width: 600px; /* Increased max-width to accommodate both features */
            padding: 12px; /* Increased padding for better UX */
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #1DB954;
            margin-bottom: 20px;
            background-color: #1C1C1C;
            color: #FFFFFF;
        }


        /* ------------------------ */
        /*        Button Styles     */
        /* ------------------------ */
        button {
            background-color: #1DB954;
            border: none;
            padding: 14px 30px; /* Increased padding for better visibility */
            font-size: 1.2em;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }


        button:active {
            transform: scale(0.95);
        }


        button:hover {
            background-color: #17a74a;
        }


        /* ------------------------ */
        /*        Hidden Sections   */
        /* ------------------------ */
        #insights-container, #additional-insights-container, #popularity-chart-container, .horizontal-lists-container, #suggested-songs-container, #summary-container, #happiness-chart-container, #tempo-chart-container, #valence-number-line-container {
            display: none;
        }


        /* ------------------------ */
        /*        Layout Styles     */
        /* ------------------------ */
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            width: 30%;
            gap: 20px;
        }


        .insight-box {
            background-color: #1C1C1C;
            margin: 10px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            position: relative;
        }


        .insight-box h3 {
            color: #1DB954;
            font-size: 1.5em;
            margin-bottom: 15px;
        }


        .playlist-info-box {
            background-color: #1C1C1C;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 45%;
            min-height: 250px;
            margin: 10px;
        }


        .playlist-info-box img {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }


        .playlist-info-text {
            text-align: center;
        }


        .circle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin: 20px 0;
            cursor: pointer;
        }


        .circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 10px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: transform 0.2s;
        }


        .circle-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#1DB954 0%, #1DB954 var(--percentage), transparent var(--percentage));
        }


        .circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em;
            color: white;
            text-align: center;
        }


        .circle:hover {
            transform: scale(1.05);
        }


        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }


        li {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            position: relative;
        }


        li img {
            margin-right: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }


        li:last-child {
            border-bottom: none;
        }


        .horizontal-lists-container {
            display: flex;
            justify-content: space-between;
            width: 90%;
            margin: 20px auto;
        }


        .insight-box-horizontal {
            width: 45%;
        }


        #popularity-chart-container, #happiness-chart-container, #tempo-chart-container, #valence-number-line-container {
            width: 80%;
            max-width: 800px;
            margin: 50px auto;
            position: relative;
        }


        /* Happiness bar styles */
        #happiness-bar-container {
            width: 100%;
            background-color: #333;
            height: 30px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }


        #happiness-bar {
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            transform-origin: left;
            background-color: red;
        }


        #happiness-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1em;
            font-weight: bold;
        }


        /* Suggested songs section */
        #suggested-songs-container {
            width: 80%;
            max-width: 800px;
            margin: 50px auto;
            background-color: #1C1C1C;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }


        /* Suggested Song Header */
        #suggested-songs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }


        #suggested-songs-header h4 {
            margin: 0;
            font-size: 1em;
            color: #1DB954;
        }


        #refresh-button {
            background-color: transparent;
            border: none;
            color: #1DB954;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
        }


        #refresh-button:hover {
            color: #17a74a;
        }


        /* Suggested Song Item */
        .suggested-song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }


        .suggested-song-item:last-child {
            border-bottom: none;
        }


        /* Match Bar Container on the Left */
        .match-bar-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 200px; /* Fixed width to ensure alignment */
            position: relative;
            flex-shrink: 0; /* Prevent shrinking */
        }


        .match-bar {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }


        .match-bar-fill {
            height: 100%;
            background-color: #1DB954;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }


        .match-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            color: #FFFFFF;
            pointer-events: none;
        }


        /* Song Info on the Right */
        .song-info {
            display: flex;
            align-items: center;
            flex: 1;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }


        .song-title {
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            transition: text-decoration 0.3s ease;
        }


        .song-title:hover {
            text-decoration: underline;
        }


        /* Tooltip for song stats and recommendation reason */
        .song-stats {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2C2C2C;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            white-space: nowrap;
            z-index: 10;
        }


        .song-title:hover .song-stats {
            display: block;
        }


        /* Tooltip arrow */
        .song-stats::before {
            content: "";
            position: absolute;
            top: -5px;
            left: 10px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #2C2C2C transparent;
        }


        /* Share Feature Styles */
        #share-feature {
            width: 80%;
            max-width: 800px;
            margin: 30px auto;
            background-color: #1C1C1C;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
        }


        #share-button {
            background-color: #1DB954;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }


        #share-button:active {
            transform: scale(0.95);
        }


        #share-button:hover {
            background-color: #17a74a;
        }


        /* Summary Container */
        #summary-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2C2C2C;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }


        #summary-container h2 {
            color: #1DB954;
            margin-bottom: 10px;
        }


        .summary-item {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 1em;
        }


        .summary-item span {
            color: #FFFFFF;
        }


        /* Feature icons and styling */
        .feature-icon {
            font-size: 24px;
            margin-right: 10px;
        }


        .insight-data {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }


        .insight-data span {
            color: #FFFFFF;
        }


        /* Valence Number Line Styles */
        #valence-number-line-container {
            position: relative;
            width: 90%;
            max-width: 1200px;
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        #valence-number-line {
            position: relative;
            width: 100%;
            height: 50px; /* Uniform height for bars */
            background: linear-gradient(to right, 
                darkred, 
                lightcoral, 
                white, 
                lightblue, 
                blue); /* Gradient from sad to happy */
            border-radius: 50px;
            display: flex;
            align-items: center; /* Align all bars at center */
            overflow: hidden;
            margin-bottom: 40px; /* Space for labels */
        }


        /* Labels */
        .label {
            position: absolute;
            top: 70px; /* Position below the number line */
            font-size: 1em;
            color: #1DB954;
        }


        #label-very-sad {
            left: 0;
        }


        #label-neutral {
            left: 50%;
            transform: translateX(-50%);
        }


        #label-very-happy {
            right: 0;
        }


        /* Song Marker Styles */
        .song-marker {
            position: absolute;
            bottom: 0; /* Align with the bottom of the bar */
            width: 4px; /* Skinny bar width */
            height: 50px; /* All bars have same height */
            background-color: #1DB954;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease, width 0.2s ease;
        }


        .song-marker:hover {
            background-color: #17a74a;
            transform: scaleX(2); /* Scale horizontally to make the bar bigger */
            /* Alternatively, you can use width: 8px; to double the width */
            /* width: 8px; */
        }


        /* Tooltip Styles */
        #tooltip {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2C2C2C;
            color: #FFFFFF;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            pointer-events: none; /* Prevent tooltip from capturing mouse events */
            text-align: center;
        }


        #tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            margin-top: 10px;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .left-column, .right-column, .playlist-info-box, .insight-box-horizontal, #popularity-chart-container, #suggested-songs-container, #share-feature, #summary-container, #happiness-chart-container, #tempo-chart-container, #valence-number-line-container {
                width: 90%;
            }


            .match-bar-container {
                width: 150px;
            }


            .song-info {
                max-width: 60%;
            }


            /* Valence Number Line Adjustments */
            #valence-number-line-container {
                width: 95%;
            }


            .label {
                font-size: 0.9em;
            }


            .song-marker {
                width: 3px;
            }


            .song-marker:hover {
                transform: scaleX(2);
            }


            #tooltip img {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>


    <h1>Spotify Playlist Insights & Mood Number Line</h1>


    <!-- ======================== -->
    <!--          Input           -->
    <!-- ======================== -->
    <div class="input-container">
        <input type="text" id="playlistUrl" placeholder="Enter Spotify playlist URL" onkeydown="if(event.key === 'Enter') { fetchPlaylist(); }">
        <button id="analyzeButton" onclick="fetchPlaylist()">Analyze</button>
    </div>


    <!-- ======================== -->
    <!--        Insights          -->
    <!-- ======================== -->
    <div id="insights-container">
        <!-- Left column: Popularity circle and Average BPM -->
        <div class="left-column">
            <!-- Popularity Circle -->
            <div class="insight-box" id="popularity-circle-box">
                <h3>Popularity</h3>
                <div class="circle-container" onclick="scrollToChart('popularity-chart-container')">
                    <div class="circle">
                        <div class="circle-inner" style="--percentage: 0%;"></div>
                        <div class="circle-text">0%</div>
                    </div>
                </div>
            </div>
            <!-- Average BPM -->
            <div class="insight-box" id="average-bpm-box">
                <h3>Average BPM</h3>
                <div class="circle-container" onclick="scrollToChart('tempo-chart-container')">
                    <div class="circle">
                        <div class="circle-inner" style="--percentage: 0%;"></div>
                        <div class="circle-text" id="average-bpm-text">0 BPM</div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Info box and audio features box in the center -->
        <div class="playlist-info-box" id="info-box">
            <img id="playlist-image" src="" alt="Playlist Image">
            <div class="playlist-info-text">
                <p id="playlist-name">Playlist: --</p>
                <p id="owner-name">Owner: --</p>
                <p id="song-count">Songs: --</p>
                <p id="followers-count">Followers: --</p>
                <p id="playlist-description"></p>
            </div>
        </div>


        <div class="playlist-info-box" id="audio-features-box">
            <h3>Audio Features</h3>
            <p class="insight-data">
                <span class="feature-icon">üíÉ</span>
                <span id="danceability">Danceability: --</span>
            </p>
            <p class="insight-data">
                <span class="feature-icon">üòä</span>
                <span id="valence">Valence (Mood): --</span>
            </p>
            <p class="insight-data">
                <span class="feature-icon">üéπ</span>
                <span id="instrumentalness">Instrumentalness: --</span>
            </p>
            <p class="insight-data">
                <span class="feature-icon">üé§</span>
                <span id="liveness">Liveness: --</span>
            </p>
            <p class="insight-data">
                <span class="feature-icon">üéª</span>
                <span id="acousticness">Acousticness: --</span>
            </p>
            <!-- Radar Chart -->
            <canvas id="audio-features-chart" width="400" height="400"></canvas>
        </div>


        <!-- Right column: Recurring artists and Mood Indicator -->
        <div class="right-column">
            <!-- Recurring Artists -->
            <div class="insight-box" id="recurring-artists-box">
                <h3>Top 5 Recurring Artists</h3>
                <ul id="recurring-artists"></ul>
            </div>
            <!-- Happiness/Sadness Bar -->
            <div class="insight-box" id="happiness-bar-box">
                <h3>Mood Indicator</h3>
                <div id="happiness-bar-container">
                    <div id="happiness-bar" style="width: 0%;"></div>
                    <div id="happiness-label">Neutral</div>
                </div>
            </div>
        </div>
    </div>


    <!-- ======================== -->
    <!--    Horizontal Lists      -->
    <!-- ======================== -->
    <div class="horizontal-lists-container" id="horizontal-lists-container">
        <!-- Top 10 Most Popular Songs -->
        <div class="insight-box insight-box-horizontal" id="top-10-popular-box">
            <h3>Top 10 Most Popular Songs</h3>
            <ul id="top-10-popular"></ul>
        </div>


        <!-- Top 10 Least Popular Songs -->
        <div class="insight-box insight-box-horizontal" id="top-10-least-popular-box">
            <h3>Top 10 Least Popular Songs</h3>
            <ul id="top-10-least-popular"></ul>
        </div>
    </div>


    <!-- ======================== -->
    <!--    Additional Insights   -->
    <!-- ======================== -->
    <div id="additional-insights-container">
        <!-- Top 5 Longest Songs -->
        <div class="insight-box" id="longest-songs-box">
            <h3>Top 5 Longest Songs</h3>
            <ul id="longest-songs"></ul>
        </div>


        <!-- Energy Level -->
        <div class="insight-box" id="energy-box">
            <h3>Average Energy Level</h3>
            <div class="circle-container">
                <div class="circle">
                    <div class="circle-inner" style="--percentage: 0%;"></div>
                    <div class="circle-text">0%</div>
                </div>
            </div>
        </div>


        <!-- Top 5 Shortest Songs -->
        <div class="insight-box" id="shortest-songs-box">
            <h3>Top 5 Shortest Songs</h3>
            <ul id="shortest-songs"></ul>
        </div>
    </div>


    <!-- ======================== -->
    <!--     Suggested Songs      -->
    <!-- ======================== -->
    <div id="suggested-songs-container">
        <div id="suggested-songs-header">
            <h4>% Match</h4>
            <button id="refresh-button" onclick="refreshSuggestions()">üîÑ Refresh</button>
        </div>
        <ul id="suggested-songs" class="suggested-songs-list"></ul>
    </div>


    <!-- ======================== -->
    <!--      Share Feature       -->
    <!-- ======================== -->
    <div id="share-feature">
        <h2>Share Your Playlist Summary</h2>
        <div id="summary-container">
            <div class="summary-item">
                <span>Playlist:</span>
                <span id="summary-playlist-name">--</span>
            </div>
            <div class="summary-item">
                <span>Owner:</span>
                <span id="summary-owner-name">--</span>
            </div>
            <div class="summary-item">
                <span>Songs:</span>
                <span id="summary-song-count">--</span>
            </div>
            <div class="summary-item">
                <span>Followers:</span>
                <span id="summary-followers-count">--</span>
            </div>
            <div class="summary-item">
                <span>Popularity:</span>
                <span id="summary-popularity">--%</span>
            </div>
            <div class="summary-item">
                <span>Danceability:</span>
                <span id="summary-danceability">--%</span>
            </div>
            <div class="summary-item">
                <span>Valence:</span>
                <span id="summary-valence">--%</span>
            </div>
            <div class="summary-item">
                <span>Average BPM:</span>
                <span id="summary-average-bpm">--</span>
            </div>
            <div class="summary-item">
                <span>Mood Indicator:</span>
                <span id="summary-happiness">--%</span>
            </div>
        </div>
        <button id="share-button">üì§ Share Summary</button>
    </div>


    <!-- ======================== -->
    <!--     Popularity Chart     -->
    <!-- ======================== -->
    <div id="popularity-chart-container">
        <h3>Popularity Distribution</h3>
        <button class="chart-info-button" onclick="toggleChartInfo()">‚ÑπÔ∏è</button>
        <div class="chart-info-popup" id="chart-info-popup">
            <p><strong>How Popularity is Calculated:</strong></p>
            <p>Spotify's popularity metric is calculated by an algorithm that combines factors such as:</p>
            <ul>
                <li>Total number of plays the track has had.</li>
                <li>Recency of those plays.</li>
                <li>Track's presence in user playlists.</li>
                <li>User interactions like sharing and saving the track.</li>
            </ul>
            <p>The popularity ranges from 0 to 100, with higher numbers indicating more popular tracks.</p>
        </div>
        <canvas id="popularity-chart" width="400" height="200"></canvas>
    </div>


    <!-- ======================== -->
    <!--      Tempo Chart         -->
    <!-- ======================== -->
    <div id="tempo-chart-container">
        <h3>Tempo Distribution</h3>
        <canvas id="tempo-chart" width="400" height="200"></canvas>
    </div>


    <!-- ======================== -->
    <!--    Valence Number Line   -->
    <!-- ======================== -->
    <div id="valence-number-line-container">
        <!-- Valence Number Line -->
        <div id="valence-number-line"></div>
        <!-- Labels -->
        <div id="label-very-sad" class="label">Very Sad</div>
        <div id="label-neutral" class="label">Neutral</div>
        <div id="label-very-happy" class="label">Very Happy</div>
        <!-- Tooltip for song info -->
        <div id="tooltip"></div>
    </div>


    <!-- ======================== -->
    <!--        Scripts           -->
    <!-- ======================== -->
    <script>
        const placeholderImage = 'https://via.placeholder.com/150?text=No+Image';
        let popularityChart; // To hold the Chart.js instance
        let tempoChart;


        // Feature keys used for similarity calculation
        const featureKeys = ['danceability', 'energy', 'instrumentalness', 'liveness', 'acousticness', 'valence', 'tempo'];


        // ============================
        //      Helper Functions
        // ============================


        function extractPlaylistId(url) {
            const regex = /playlist\/([a-zA-Z0-9]+)(\?|$)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }


        function scrollToChart(chartId) {
            document.getElementById(chartId).scrollIntoView({ behavior: 'smooth' });
        }


        function toggleChartInfo() {
            const infoPopup = document.getElementById('chart-info-popup');
            if (!chartInfoVisible) {
                infoPopup.classList.remove('fade-out');
                infoPopup.classList.add('fade-in');
                infoPopup.style.display = 'block';
                chartInfoVisible = true;


                // Auto-hide after 8 seconds
                chartInfoTimeout = setTimeout(() => {
                    toggleChartInfo();
                }, 8000);
            } else {
                infoPopup.classList.remove('fade-in');
                infoPopup.classList.add('fade-out');
                clearTimeout(chartInfoTimeout);
                chartInfoVisible = false;


                setTimeout(() => {
                    infoPopup.style.display = 'none';
                }, 500);
            }
        }


        let chartInfoVisible = false;
        let chartInfoTimeout;


        async function getAccessToken() {
            const clientId = '62144b5acdc242d7bcd0a98a1d293ac7';
            const clientSecret = '967766e36b9e451c8c6f31041a80eddf';
            const authString = btoa(`${clientId}:${clientSecret}`);


            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${authString}`,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'grant_type': 'client_credentials'
                }),
            });


            const data = await response.json();
            return data.access_token;
        }


        async function getPlaylist(playlistId, accessToken) {
            const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}?market=US`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });


            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Failed to fetch playlist.');
            }


            return await response.json();
        }


        async function getArtistAlbumCover(artistId, accessToken) {
            const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}/albums?limit=1&market=US`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });


            const data = await response.json();
            return data.items.length > 0 ? data.items[0].images[0]?.url : placeholderImage;
        }


        async function getAudioFeatures(trackIds, accessToken) {
            const audioFeatures = [];
            for (let i = 0; i < trackIds.length; i += 100) {
                const batchIds = trackIds.slice(i, i + 100);
                const response = await fetch(`https://api.spotify.com/v1/audio-features?ids=${batchIds.join(',')}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message || 'Failed to fetch audio features.');
                }
                audioFeatures.push(...data.audio_features);
            }
            return audioFeatures;
        }


        async function getRecommendedTracks(seedTracks, accessToken) {
            const url = `https://api.spotify.com/v1/recommendations?limit=10&seed_tracks=${seedTracks.join(',')}`;


            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });


            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Failed to fetch recommendations.');
            }


            const data = await response.json();
            return data.tracks;
        }


        function calculatePopularity(trackPopularities) {
            const avgPopularity = trackPopularities.reduce((a, b) => a + b, 0) / trackPopularities.length;
            const maxSpotifyPopularity = 100;
            const popularityPercent = Math.round((avgPopularity / maxSpotifyPopularity) * 100);
            return popularityPercent;
        }


        // Function to calculate cosine similarity
        function cosineSimilarity(vecA, vecB) {
            const dotProduct = vecA.reduce((sum, a, idx) => sum + a * vecB[idx], 0);
            const magnitudeA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const magnitudeB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            if (magnitudeA === 0 || magnitudeB === 0) return 0;
            return dotProduct / (magnitudeA * magnitudeB);
        }


        // ============================
        //      Display Functions
        // ============================


        async function displayInsights(playlist) {
            // Show all relevant containers
            document.getElementById('insights-container').style.display = 'flex';
            document.getElementById('additional-insights-container').style.display = 'flex';
            document.getElementById('popularity-chart-container').style.display = 'block';
            document.getElementById('tempo-chart-container').style.display = 'block';
            document.getElementById('horizontal-lists-container').style.display = 'flex';
            document.getElementById('suggested-songs-container').style.display = 'block';
            document.getElementById('share-feature').style.display = 'block';
            document.getElementById('valence-number-line-container').style.display = 'flex';


            document.body.style.justifyContent = 'flex-start';


            const trackIds = playlist.tracks.items.map(track => track.track.id).filter(id => id);
            const trackPopularities = playlist.tracks.items.map(track => track.track.popularity).filter(p => p !== undefined && p !== null);


            // Populate playlist info
            document.getElementById('playlist-image').src = playlist.images.length ? playlist.images[0].url : placeholderImage;
            document.getElementById('playlist-name').textContent = `Playlist: ${playlist.name}`;
            document.getElementById('owner-name').textContent = `Owner: ${playlist.owner.display_name}`;
            document.getElementById('song-count').textContent = `Songs: ${playlist.tracks.total}`;
            document.getElementById('followers-count').textContent = `Followers: ${playlist.followers.total || 'Unknown'}`;
            document.getElementById('playlist-description').textContent = playlist.description || '';


            // Populate Summary Container
            document.getElementById('summary-playlist-name').textContent = playlist.name;
            document.getElementById('summary-owner-name').textContent = playlist.owner.display_name;
            document.getElementById('summary-song-count').textContent = playlist.tracks.total;
            document.getElementById('summary-followers-count').textContent = playlist.followers.total || 'Unknown';
            const popularityPercent = calculatePopularity(trackPopularities);
            document.getElementById('summary-popularity').textContent = `${Math.round(popularityPercent)}%`;


            // Calculate and display popularity percentage
            document.querySelector('#popularity-circle-box .circle-inner').style.setProperty('--percentage', `${popularityPercent}%`);
            document.querySelector('#popularity-circle-box .circle-text').textContent = `${Math.round(popularityPercent)}%`;


            // Display energy level in circle and other audio features
            const playlistAudioFeatures = await getAudioFeatures(trackIds, await getAccessToken());
            const avgFeature = (key) => playlistAudioFeatures.reduce((acc, feature) => acc + feature[key], 0) / playlistAudioFeatures.length;
            const avgEnergy = avgFeature('energy') * 100;
            document.querySelector('#energy-box .circle-inner').style.setProperty('--percentage', `${avgEnergy}%`);
            document.querySelector('#energy-box .circle-text').textContent = `${Math.round(avgEnergy)}%`;


            // Prepare features data for the chart
            const avgFeatures = {
                danceability: avgFeature('danceability'),
                energy: avgFeature('energy'),
                valence: avgFeature('valence'),
                instrumentalness: avgFeature('instrumentalness'),
                liveness: avgFeature('liveness'),
                acousticness: avgFeature('acousticness')
            };


            // Display the audio features chart
            displayAudioFeaturesChart(avgFeatures);


            // Update Summary Container with Audio Features
            document.getElementById('summary-danceability').textContent = `${Math.round(avgFeatures.danceability * 100)}%`;
            document.getElementById('summary-valence').textContent = `${Math.round(avgFeatures.valence * 100)}%`;


            // Update audio features text with emojis
            document.getElementById('danceability').textContent = `Danceability: ${Math.round(avgFeatures.danceability * 100)}%`;
            document.getElementById('valence').textContent = `Valence (Mood): ${Math.round(avgFeatures.valence * 100)}%`;
            document.getElementById('instrumentalness').textContent = `Instrumentalness: ${Math.round(avgFeatures.instrumentalness * 100)}%`;
            document.getElementById('liveness').textContent = `Liveness: ${Math.round(avgFeatures.liveness * 100)}%`;
            document.getElementById('acousticness').textContent = `Acousticness: ${Math.round(avgFeatures.acousticness * 100)}%`;


            // Calculate average BPM
            const avgTempo = avgFeature('tempo');
            document.getElementById('average-bpm-text').textContent = `${Math.round(avgTempo)} BPM`;
            document.querySelector('#average-bpm-box .circle-inner').style.setProperty('--percentage', `${(avgTempo / 200) * 100}%`); // Assuming 200 BPM is max


            document.getElementById('summary-average-bpm').textContent = `${Math.round(avgTempo)} BPM`;


            // Calculate happiness/sadness score based on valence
            const avgValence = avgFeature('valence');
            const happinessPercent = (avgValence - 0.5) * 200; // Range from -100 to 100
            document.getElementById('summary-happiness').textContent = `${Math.round(avgValence * 100)}%`;


            // Update happiness bar
            const happinessBar = document.getElementById('happiness-bar');
            const happinessLabel = document.getElementById('happiness-label');


            if (happinessPercent >= 0) {
                happinessBar.style.left = '50%';
                happinessBar.style.width = `${happinessPercent}%`;
                happinessBar.style.backgroundColor = 'red';
                happinessLabel.textContent = 'Happy';
            } else {
                happinessBar.style.left = `${50 + happinessPercent}%`;
                happinessBar.style.width = `${-happinessPercent}%`;
                happinessBar.style.backgroundColor = 'blue';
                happinessLabel.textContent = 'Sad';
            }


            // Populate top 10 most and least popular songs
            const sortedTracks = [...playlist.tracks.items].sort((a, b) => b.track.popularity - a.track.popularity);
            const topTracks = sortedTracks.slice(0, 10);
            const leastTracks = sortedTracks.slice(-10);
            document.getElementById('top-10-popular').innerHTML = topTracks.map(track => `
                <li><img src="${track.track.album.images[2]?.url || placeholderImage}" class="album-cover">${track.track.name}</li>
            `).join('');
            document.getElementById('top-10-least-popular').innerHTML = leastTracks.map(track => `
                <li><img src="${track.track.album.images[2]?.url || placeholderImage}" class="album-cover">${track.track.name}</li>
            `).join('');


            // Populate top 5 recurring artists
            const artistCount = {};
            playlist.tracks.items.forEach(item => {
                item.track.artists.forEach(artist => {
                    artistCount[artist.id] = artistCount[artist.id] || { name: artist.name, count: 0 };
                    artistCount[artist.id].count += 1;
                });
            });


            const sortedArtistsRecurring = Object.entries(artistCount)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);


            const artistElements = Promise.all(
                sortedArtistsRecurring.map(async ([artistId, artistData]) => {
                    const artistImage = await getArtistAlbumCover(artistId, await getAccessToken());
                    return `<li class="artist"><img src="${artistImage}" alt="${artistData.name}"> ${artistData.name} - ${artistData.count} songs</li>`;
                })
            );


            artistElements.then(result => {
                document.getElementById('recurring-artists').innerHTML = result.join('');
            });


            // Populate top 5 longest and shortest songs
            const longestTracks = [...playlist.tracks.items].sort((a, b) => b.track.duration_ms - a.track.duration_ms).slice(0, 5);
            const shortestTracks = [...playlist.tracks.items].sort((a, b) => a.track.duration_ms - b.track.duration_ms).slice(0, 5);


            document.getElementById('longest-songs').innerHTML = longestTracks.map(track => `
                <li><img src="${track.track.album.images[2]?.url || placeholderImage}" class="album-cover">${track.track.name} (${(track.track.duration_ms / 60000).toFixed(2)} min)</li>
            `).join('');
            document.getElementById('shortest-songs').innerHTML = shortestTracks.map(track => `
                <li><img src="${track.track.album.images[2]?.url || placeholderImage}" class="album-cover">${track.track.name} (${(track.track.duration_ms / 60000).toFixed(2)} min)</li>
            `).join('');


            // Prepare data for popularity chart
            const popularityRanges = [
                { min: 1, max: 10 },
                { min: 11, max: 20 },
                { min: 21, max: 30 },
                { min: 31, max: 40 },
                { min: 41, max: 50 },
                { min: 51, max: 60 },
                { min: 61, max: 70 },
                { min: 71, max: 80 },
                { min: 81, max: 90 },
                { min: 91, max: 100 },
            ];


            const popularityCounts = new Array(popularityRanges.length).fill(0);
            trackPopularities.forEach(popularity => {
                for (let i = 0; i < popularityRanges.length; i++) {
                    if (popularity >= popularityRanges[i].min && popularity <= popularityRanges[i].max) {
                        popularityCounts[i]++;
                        break;
                    }
                }
            });


            const labels = popularityRanges.map(range => `${range.min}-${range.max}`);


            // Create the popularity chart with the correct data
            const ctxPopularity = document.getElementById('popularity-chart').getContext('2d');
            if (popularityChart) {
                popularityChart.destroy(); // Destroy previous chart if it exists
            }
            popularityChart = new Chart(ctxPopularity, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Songs',
                        data: popularityCounts,
                        backgroundColor: '#1DB954',
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFFFFF'
                            }
                        }
                    }
                }
            });


            // Prepare data for tempo chart
            const tempos = playlistAudioFeatures.map(feature => feature.tempo);
            const tempoRanges = [
                { min: 0, max: 60 },
                { min: 61, max: 90 },
                { min: 91, max: 120 },
                { min: 121, max: 150 },
                { min: 151, max: 200 },
            ];


            const tempoCounts = new Array(tempoRanges.length).fill(0);
            tempos.forEach(tempo => {
                for (let i = 0; i < tempoRanges.length; i++) {
                    if (tempo >= tempoRanges[i].min && tempo <= tempoRanges[i].max) {
                        tempoCounts[i]++;
                        break;
                    }
                }
            });


            const tempoLabels = tempoRanges.map(range => `${range.min}-${range.max} BPM`);


            // Create the tempo chart
            const ctxTempo = document.getElementById('tempo-chart').getContext('2d');
            if (tempoChart) {
                tempoChart.destroy();
            }
            tempoChart = new Chart(ctxTempo, {
                type: 'bar',
                data: {
                    labels: tempoLabels,
                    datasets: [{
                        label: 'Number of Songs',
                        data: tempoCounts,
                        backgroundColor: '#FF4500',
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFFFFF'
                            }
                        }
                    }
                }
            });


            // Fetch suggested songs based on seed tracks
            const seedTracks = playlist.tracks.items.slice(0, 3).map(item => item.track.id);
            const suggestedTracks = await getRecommendedTracks(seedTracks, await getAccessToken());


            // Fetch audio features for suggested tracks
            const suggestedTrackIds = suggestedTracks.map(track => track.id);
            const suggestedAudioFeatures = await getAudioFeatures(suggestedTrackIds, await getAccessToken());


            // Calculate average playlist features
            const averagePlaylistFeatures = featureKeys.map(key => {
                return playlistAudioFeatures.reduce((sum, feature) => sum + feature[key], 0) / playlistAudioFeatures.length;
            });


            // Calculate match percentage and prepare stats
            const suggestedTracksWithMatch = suggestedTracks.map((track, index) => {
                const trackFeatures = suggestedAudioFeatures[index];
                const trackVector = featureKeys.map(key => trackFeatures[key]);
                const similarity = cosineSimilarity(averagePlaylistFeatures, trackVector);
                const matchPercentage = Math.round(similarity * 100);


                // Stats to display on hover
                const stats = `
                    Popularity: ${track.popularity}<br>
                    Tempo: ${Math.round(trackFeatures.tempo)} BPM<br>
                    Valence: ${(trackFeatures.valence * 100).toFixed(1)}%<br>
                    Length: ${(track.duration_ms / 60000).toFixed(2)} min<br>
                    Danceability: ${(trackFeatures.danceability * 100).toFixed(1)}%<br>
                    Energy: ${(trackFeatures.energy * 100).toFixed(1)}%<br>
                `;


                return {
                    ...track,
                    matchPercentage,
                    stats
                };
            });


            // Display suggested songs with match bars and hover stats
            const suggestedSongsElement = document.getElementById('suggested-songs');
            suggestedSongsElement.innerHTML = suggestedTracksWithMatch.map(track => `
                <li>
                    <div class="suggested-song-item">
                        <div class="match-bar-container">
                            <div class="match-bar">
                                <div class="match-bar-fill" style="width: ${track.matchPercentage}%;"></div>
                                <span class="match-percentage">${track.matchPercentage}%</span>
                            </div>
                        </div>
                        <div class="song-info">
                            <img src="${track.album.images[2]?.url || placeholderImage}" alt="Album Cover">
                            <span class="song-title">
                                ${track.name} by ${track.artists.map(artist => artist.name).join(', ')}
                                <div class="song-stats">
                                    ${track.stats}
                                </div>
                            </span>
                        </div>
                    </div>
                </li>
            `).join('');


            // Update Summary Container Audio Features
            document.getElementById('summary-danceability').textContent = `${Math.round(avgFeatures.danceability * 100)}%`;
            document.getElementById('summary-valence').textContent = `${Math.round(avgFeatures.valence * 100)}%`;
        }


        // Function to display the audio features chart
        function displayAudioFeaturesChart(features) {
            const ctx = document.getElementById('audio-features-chart').getContext('2d');


            const data = {
                labels: ['Danceability', 'Energy', 'Valence', 'Instrumentalness', 'Liveness', 'Acousticness'],
                datasets: [{
                    label: 'Average Audio Features',
                    data: [
                        features.danceability,
                        features.energy,
                        features.valence,
                        features.instrumentalness,
                        features.liveness,
                        features.acousticness
                    ],
                    backgroundColor: 'rgba(29, 185, 84, 0.2)',
                    borderColor: 'rgba(29, 185, 84, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(29, 185, 84, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(29, 185, 84, 1)'
                }]
            };


            const options = {
                scales: {
                    r: {
                        angleLines: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        },
                        ticks: {
                            beginAtZero: true,
                            max: 1,
                            min: 0,
                            stepSize: 0.2,
                            display: false
                        },
                        pointLabels: {
                            color: '#fff',
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };


            new Chart(ctx, {
                type: 'radar',
                data: data,
                options: options
            });
        }


        // ============================
        //      Valence Number Line
        // ============================


        function categorizeMood(valence) {
            if (valence <= 0.2) return 'Very Sad';
            if (valence <= 0.4) return 'Sad';
            if (valence <= 0.6) return 'Neutral';
            if (valence <= 0.8) return 'Happy';
            return 'Very Happy';
        }


        function displayValenceNumberLine(tracks) {
            const numberLine = document.getElementById('valence-number-line');
            const tooltip = document.getElementById('tooltip');
            numberLine.innerHTML = ''; // Clear previous markers


            tracks.forEach((track) => {
                const valence = track.valence; // 0 to 1
                const positionPercentage = valence * 100;


                // Calculate mood based on valence
                const mood = valence >= 0.5 ? `${Math.round(valence * 100)}% Happy` : `${Math.round((1 - valence) * 100)}% Sad`;
                const moodCategory = categorizeMood(valence);


                // Create song marker (skinny bar)
                const marker = document.createElement('div');
                marker.className = 'song-marker';
                marker.style.left = `${positionPercentage}%`;


                // Event listeners for tooltip
                marker.addEventListener('mouseenter', () => {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <strong>${track.name}</strong><br>
                        ${mood} (${moodCategory})<br>
                        <img src="${track.albumCover}" alt="Album Cover">
                    `;
                });


                marker.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });


                numberLine.appendChild(marker);
            });
        }


        // ============================
        //      Refresh Suggestions
        // ============================


        async function refreshSuggestions() {
            const playlistUrl = document.getElementById('playlistUrl').value;
            const playlistId = extractPlaylistId(playlistUrl);


            if (!playlistId) {
                alert('Please enter a valid Spotify playlist URL!');
                return;
            }


            try {
                // Optionally, you can show a loading indicator here
                const accessToken = await getAccessToken();
                const playlistData = await getPlaylist(playlistId, accessToken);
                displayInsights(playlistData);
            } catch (error) {
                alert('An error occurred while fetching the playlist data. Please ensure the URL is correct and try again.');
                console.error(error);
            }
        }


        // ============================
        //      Fetch Playlist
        // ============================


        async function fetchPlaylist() {
            const playlistUrl = document.getElementById('playlistUrl').value.trim();
            const playlistId = extractPlaylistId(playlistUrl);


            if (!playlistId) {
                alert('Please enter a valid Spotify playlist URL!');
                return;
            }


            try {
                const accessToken = await getAccessToken();
                const playlistData = await getPlaylist(playlistId, accessToken);
                
                // Extract Track IDs and Names with Album Covers
                const tracks = playlistData.tracks.items
                    .map(item => ({
                        id: item.track.id,
                        name: item.track.name,
                        albumCover: item.track.album.images[0]?.url || placeholderImage
                    }))
                    .filter(track => track.id); // Ensure the track has an ID


                const trackIds = tracks.map(track => track.id);
                const audioFeatures = await getAudioFeatures(trackIds, accessToken);


                // Combine tracks with their valence scores
                const tracksWithValence = tracks.map((track, index) => ({
                    ...track,
                    valence: audioFeatures[index]?.valence
                })).filter(track => track.valence !== null); // Filter out tracks with no valence


                // Display Insights
                displayInsights(playlistData);


                // Display Mood Number Line
                displayValenceNumberLine(tracksWithValence);
            } catch (error) {
                alert('An error occurred while fetching the playlist data. Please ensure the URL is correct and try again.');
                console.error(error);
            }
        }


        // ============================
        //      Share Feature
        // ============================


        document.getElementById('share-button').addEventListener('click', async () => {
            const summary = document.getElementById('summary-container');


            // Use html2canvas to capture the summary container
            html2canvas(summary, { scale: 2 }).then(canvas => {
                canvas.toBlob(async blob => {
                    const file = new File([blob], 'playlist-summary.png', { type: 'image/png' });
                    const fileURL = URL.createObjectURL(file);


                    // Check if Web Share API is supported
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'My Spotify Playlist Summary',
                                text: 'Check out my Spotify playlist stats!',
                            });
                            console.log('Share successful');
                        } catch (err) {
                            console.error('Share failed:', err);
                            alert('Sharing failed or was canceled.');
                        }
                    } else {
                        // Fallback: Provide a download link
                        const link = document.createElement('a');
                        link.href = fileURL;
                        link.download = 'playlist-summary.png';
                        link.textContent = 'Download Summary Image';
                        link.style.display = 'block';
                        link.style.marginTop = '10px';
                        link.style.color = '#1DB954';
                        link.style.textDecoration = 'underline';
                        link.style.cursor = 'pointer';
                        const shareFeature = document.getElementById('share-feature');
                        shareFeature.appendChild(link);
                        alert('Web Share API not supported. Please download the summary image.');
                    }
                });
            });
        });
    </script>


</body>
</html>





